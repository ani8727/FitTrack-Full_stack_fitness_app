@startuml User_Registration_Sequence
title User Registration Flow

actor User
participant "React SPA" as SPA
participant "API Gateway" as Gateway
participant "User Service" as UserSvc
participant "Keycloak" as KC
participant "PostgreSQL" as DB
participant "RabbitMQ" as MQ
participant "Redis Cache" as Cache

User -> SPA: Fill registration form
activate SPA

SPA -> Gateway: POST /api/users/register\n(firstName, lastName, email, password)
activate Gateway

Gateway -> KC: Validate request token
activate KC
KC --> Gateway: Token validation result
deactivate KC

alt Token Valid
    Gateway -> UserSvc: Forward registration request\n(with user context)
    activate UserSvc
    
    UserSvc -> KC: Create user account\n(email, password, roles)
    activate KC
    KC --> UserSvc: User account created\n(userId, email)
    deactivate KC
    
    UserSvc -> DB: INSERT INTO users\n(userId, email, profile data)
    activate DB
    DB --> UserSvc: User record saved\n(internal ID)
    deactivate DB
    
    UserSvc -> Cache: Cache user profile\nKEY: user:{userId}
    activate Cache
    Cache --> UserSvc: Profile cached
    deactivate Cache
    
    UserSvc -> MQ: Publish user.onboarded event\n(userId, email, timestamp)
    activate MQ
    MQ --> UserSvc: Event published
    deactivate MQ
    
    UserSvc --> Gateway: UserResponse\n(id, userId, email, profile)
    deactivate UserSvc
    
    Gateway --> SPA: 201 Created\n(UserResponse)
    deactivate Gateway
    
    SPA --> User: Registration successful\nRedirect to onboarding
    deactivate SPA
    
else Token Invalid
    Gateway --> SPA: 401 Unauthorized
    SPA --> User: Authentication error
end

@enduml