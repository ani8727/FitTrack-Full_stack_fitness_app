@startuml Activity_Tracking_Sequence
title Activity Tracking Flow with AI Processing

actor User
participant "React SPA" as SPA
participant "API Gateway" as Gateway
participant "Activity Service" as ActSvc
participant "MongoDB" as Mongo
participant "Redis Cache" as Cache
participant "RabbitMQ" as MQ
participant "AI Service" as AI

User -> SPA: Submit activity data\n(name, type, duration, calories)
activate SPA

SPA -> Gateway: POST /api/activities\n(ActivityRequest + JWT token)
activate Gateway

Gateway -> Gateway: Validate JWT token\nExtract user ID and roles

Gateway -> ActSvc: POST /activities\n(ActivityRequest + X-User-ID header)
activate ActSvc

ActSvc -> ActSvc: Validate activity data\nCalculate calories if missing

ActSvc -> Mongo: db.activities.insertOne()\n(activity document)
activate Mongo
Mongo --> ActSvc: Activity saved\n(activityId, timestamp)
deactivate Mongo

ActSvc -> Cache: HDEL user_activity_stats:{userId}\nInvalidate cached statistics
activate Cache
Cache --> ActSvc: Cache invalidated
deactivate Cache

ActSvc -> MQ: Publish to activity.exchange\nrouting_key: "activity.recorded"\n(ActivityEvent)
activate MQ
MQ --> ActSvc: Event published
deactivate MQ

ActSvc --> Gateway: 201 Created\n(ActivityResponse)
deactivate ActSvc

Gateway --> SPA: ActivityResponse\n(id, name, calories, etc.)
deactivate Gateway

SPA --> User: Activity tracked successfully
deactivate SPA

' Asynchronous AI processing
MQ -> AI: Consume activity.recorded event\n(ActivityEvent from queue)
activate AI

AI -> Mongo: db.activities.find({userId})\nFetch user's recent activities
activate Mongo
Mongo --> AI: Recent activities list
deactivate Mongo

AI -> AI: Analyze patterns\nGenerate insights\nCreate recommendations

AI -> Mongo: db.user_insights.replaceOne()\n(UserInsights document)
activate Mongo
Mongo --> AI: Insights saved
deactivate Mongo

AI -> Mongo: db.recommendations.insertMany()\n(Recommendation documents)
activate Mongo
Mongo --> AI: Recommendations saved
deactivate Mongo

deactivate AI

@enduml